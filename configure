#!/bin/bash

git_version() {
    local tag count

    tag=$(git describe --abbrev=0 2>/dev/null)
    if [[ -z $tag ]]; then
        tag="0.1.0"
    else
        count=$(git rev-list --count "$tag"..HEAD)
        [[ $count -gt 0 ]] && tag="$tag-dev.$count"
    fi
    echo "$tag"
}

PROJECT_NAME="fbxkb"
PROJECT_VERSION=$(git_version)

mkdir -p output

CONF_MK=output/config.mk
cat >"$CONF_MK" <<EOF
PROJECT_NAME := ${PROJECT_NAME}
PROJECT_VERSION := ${PROJECT_VERSION}

PREFIX := ${PREFIX:-/usr}
BIN_DIR = \$(PREFIX)/bin
LIB_DIR = \$(PREFIX)/lib
DATA_DIR = \$(PREFIX)/share/\$(PROJECT_NAME)/flags

GTK2_CFLAGS := $(pkg-config gtk+-2.0 --cflags)
GTK2_LIBS := $(pkg-config gtk+-2.0 --libs)
EOF

CONF_H=output/config.h
cat >"$CONF_H" <<EOF
#define PROJECT_NAME "${PROJECT_NAME}"
#define PROJECT_VERSION "${PROJECT_VERSION}"

#define PREFIX "${PREFIX:-/usr}"
#define DATA_DIR PREFIX "/share/" PROJECT_NAME "/flags"
EOF
